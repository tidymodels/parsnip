<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making a <code>parsnip</code> model from scratch • parsnip</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="Making a &lt;code&gt;parsnip&lt;/code&gt; model from scratch">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../../index.html">parsnip</a>
        <div class="info">
          <span class="partof">part of <a href="https://github.com/tidymodels">tidymodels</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.0.2.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../articles/parsnip_Intro.html">Basic Usage</a>
</li>
<li>
  <a href="../../articles/articles/Models.html">Model List</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/Regression.html">Regression modeling</a>
    </li>
    <li>
      <a href="../../articles/articles/Classification.html">Classification modeling</a>
    </li>
    <li>
      <a href="../../articles/articles/Scratch.html">Making a parsnip model from scratch</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
        
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Making a <code>parsnip</code> model from scratch</h1>
            
      
      
      <div class="hidden name"><code>Scratch.Rmd</code></div>

    </div>

    
    
<p><code>parsnip</code> constructs models and predictions by representing those actions in expressions. There are a few reasons for this:</p>
<ul>
<li>It eliminates a lot of duplicate code.</li>
<li>Since the expressions are not evaluated until fitting, it eliminates a large amount of package dependencies.</li>
</ul>
<p>A <code>parsnip</code> model function is itself very general. For example, the <code>logistic_reg</code> function itself doesn’t have any model code within it. Instead, each model function is associated with one or more computational <em>engines</em>. These might be different R packages or some function in another language (that can be evaluated by R).</p>
<p>This vignette describes the process of creating a new model function. Before proceeding, take a minute and read our <a href="https://tidymodels.github.io/model-implementation-principles/">guidelines on creating modeling packages</a> to get the general themes and conventions that we use.</p>
<p>As an example, we’ll create a function for <em>mixture discriminant analysis</em>. There are <a href="http://search.r-project.org/cgi-bin/namazu.cgi?query=%22mixture+discriminant%22&amp;max=100&amp;result=normal&amp;sort=score&amp;idxname=functions">a few packages</a> that do this but we’ll focus on <code><a href="https://www.rdocumentation.org/packages/mda/topics/mda">mda::mda</a></code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(mda<span class="op">::</span>mda)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="co">#&gt; function (formula = formula(data), data = sys.frame(sys.parent()), </span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="co">#&gt;     subclasses = 3, sub.df = NULL, tot.df = NULL, dimension = sum(subclasses) - </span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#&gt;         1, eps = .Machine$double.eps, iter = 5, weights = mda.start(x, </span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt;         g, subclasses, trace, ...), method = polyreg, keep.fitted = (n * </span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#&gt;         dimension &lt; 5000), trace = FALSE, ...)</span></a></code></pre></div>
<p>The main hyper-parameter is the number of subclasses. We’ll name our function <code>mixture_da</code>.</p>
<div id="step-1--make-the-objects-for-the-general-method" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1--make-the-objects-for-the-general-method" class="anchor"></a>Step 1. Make the objects for the general method</h2>
<p>There are three objects that define the parameters and other characteristics of the model function.</p>
<p>First, is the object that describes the model’s mode(s). The modes are the type of model and the two main values are “classification” and “regression”. A third mode, “unknown”, is used for initializing objects but models will fail if it is used further.</p>
<p>The convention in <code>parsnip</code> is to use the name <code>{model name}_modes</code>. In our case, we have:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">mixture_da_modes &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"classification"</span>, <span class="st">"unknown"</span>)</a></code></pre></div>
<p>Next, we define the engines used by the model and the associated mode. Here, the columns correspond to the engine names and rows are the modes (via row names). We have two engines and one effective mode, so our object will have the suffix <code>_engines</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mixture_da_engines &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="dt">mda      =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  <span class="dt">row.names =</span>  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"classification"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">mixture_da_engines</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;                 mda</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; classification TRUE</span></a></code></pre></div>
<p>A row for “unknown” modes is not needed in this object.</p>
<p>Now, we enumerate the <em>main arguments</em> for each engine. <code>parsnip</code> standardizes the names of arguments across different models and engines. For example, random forest and boosting use multiple trees to create the ensemble. Instead of using different argument names, <code>parsnip</code> standardizes on <code>trees</code> and the underlying code translates to the actual arguments used by the different functions.</p>
<p>In our case, the MDA argument name will be “sub_classes”.</p>
<p>Here, the object name will have the suffix <code>_arg_key</code> and will have columns for the engines and rows for the arguments. The entries for the data frame are the actual arguments for each engine (and is <code>NA</code> when an engine doesn’t have that argument). Ours:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">mixture_da_arg_key &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="dt">mda      =</span>   <span class="st">"sub_classes"</span>,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="dt">row.names =</span>  <span class="st">"sub_classes"</span>,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">)</a></code></pre></div>
<p>As an example of a model with multiple engines, here is the object for logistic regression:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">parsnip<span class="op">:::</span>logistic_reg_arg_key</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt;         glm glmnet             spark stan keras</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; penalty  NA lambda         reg_param   NA decay</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; mixture  NA  alpha elastic_net_param   NA  &lt;NA&gt;</span></a></code></pre></div>
<p>The internals of <code>parsnip</code> will use these objects during the creation of the model code.</p>
</div>
<div id="step-2--create-the-model-function" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2--create-the-model-function" class="anchor"></a>Step 2. Create the model function</h2>
<p>This is a fairly simple function that can follow a basic template. The main arguments to our function will be:</p>
<ul>
<li>The mode. If the model can do more than one mode, you might default this to “unknown”. In our case, since it is only a classification model, it makes sense to default it to that mode.</li>
<li>The argument names (<code>sub_classes</code> here). These should be defaulted to <code>NULL</code>.</li>
<li>
<code>...</code> are <em>not</em> used in the main model function.</li>
</ul>
<p>A basic version of the function is:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">mixture_da &lt;-</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="st">  </span><span class="cf">function</span>(<span class="dt">mode =</span> <span class="st">"classification"</span>,  <span class="dt">sub_classes =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="co"># Check for correct mode</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="cf">if</span> (<span class="op">!</span>(mode <span class="op">%in%</span><span class="st"> </span>mixture_da_modes))</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop</a></span>(<span class="st">"`mode` should be one of: "</span>,</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">           <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"'"</span>, mixture_da_modes, <span class="st">"'"</span>, <span class="dt">collapse =</span> <span class="st">", "</span>),</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">           <span class="dt">call. =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    </a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="co"># Capture the arguments in quosures</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    args &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">sub_classes =</span> rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/quotation.html">enquo</a></span>(sub_classes))</a>
<a class="sourceLine" id="cb6-11" data-line-number="11"></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">    <span class="co"># Save some empty slots for future parts of the specification</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    out &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">args =</span> args, <span class="dt">eng_args =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">                <span class="dt">mode =</span> mode, <span class="dt">method =</span> <span class="ot">NULL</span>, <span class="dt">engine =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    </a>
<a class="sourceLine" id="cb6-16" data-line-number="16">    <span class="co"># set classes in the correct order</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17">    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/class">class</a></span>(out) &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/make_classes.html">make_classes</a></span>(<span class="st">"mixture_da"</span>)</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">    out</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">  }</a></code></pre></div>
<p>This is pretty simple since the data are not exposed to this function.</p>
</div>
<div id="step-3--make-the-model-object" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3--make-the-model-object" class="anchor"></a>Step 3. Make the model object</h2>
<p>This is where the details of the models are specified. This will be a list that has a few different elements:</p>
<ul>
<li>
<code>libs</code> is a character string that has any package names that will be required for the model fit.</li>
<li>
<code>fit</code> has details for the model fit function.</li>
<li>
<code>pred</code>, <code>prob</code>, and <code>classes</code>. These are lists of details for making predictions on numbers, class probabilities, or hard class predictions (respectively).</li>
</ul>
<p>We’ll look at each. The convention here is to name this <code>{model name}_{engine}_data</code>. We’ll start with:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">mixture_da_mda_data &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">libs =</span> <span class="st">"mda"</span>)</a></code></pre></div>
<div id="the-fit-module" class="section level3">
<h3 class="hasAnchor">
<a href="#the-fit-module" class="anchor"></a>The <code>fit</code> module</h3>
<p>The main arguments are:</p>
<ul>
<li>
<code>interface</code> a single character value that could be “formula”, “data.frame”, or “matrix”. This defines the type of interface used by the underlying fit function (<code><a href="https://www.rdocumentation.org/packages/mda/topics/mda">mda::mda</a></code>, in this case). This helps the translation of the data to be in an appropriate format for the that function.</li>
<li>
<code>protect</code> is an optional list of function arguments that <strong>should not be changeable</strong> by the user. In this case, we probably don’t want users to pass data values to these arguments (until the <code>fit</code> function is called).</li>
<li>
<code>func</code> is the package and name of the function that will be called. If you are using a locally defined function, only <code>fun</code> is required.</li>
<li>
<code>defaults</code> is an optional list of arguments to the fit function that the user can change, but whose defaults can be set here. This isn’t needed in this case, but is describe later in this document.</li>
</ul>
<p>For the first engine:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">mixture_da_mda_data<span class="op">$</span>fit &lt;-</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">    <span class="dt">interface =</span> <span class="st">"formula"</span>,</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="dt">protect =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"formula"</span>, <span class="st">"data"</span>, <span class="st">"weights"</span>),</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">    <span class="dt">func =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">pkg =</span> <span class="st">"mda"</span>, <span class="dt">fun =</span> <span class="st">"mda"</span>),</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    <span class="dt">defaults =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>()</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  )</a></code></pre></div>
</div>
<div id="the-numeric-module" class="section level3">
<h3 class="hasAnchor">
<a href="#the-numeric-module" class="anchor"></a>The <code>numeric</code> module</h3>
<p>This is defined only for regression models (so is not added to the list). The convention used here is very similar to the two that are detailed in the next section. For <code>numeric</code>, the model requires an unnamed numeric vector output (usually).</p>
<p>Examples are <a href="https://github.com/topepo/parsnip/blob/master/R/linear_reg_data.R">here</a> and <a href="https://github.com/topepo/parsnip/blob/master/R/rand_forest_data.R">here</a>.</p>
<p>For multivariate models, the return value should be a matrix or data frame (otherwise a vector should be the results).</p>
<p>Note that the <code>numeric</code> module maps to the <code>predict_numeric</code> function in <code>parsnip</code>. However, the user-facing <code>predict</code> function is used to generate predictions and returns a tibble with a column named <code>.pred</code> (see the example below). When creating new models, you don’t have to write code for that part.</p>
</div>
<div id="the-class-module" class="section level3">
<h3 class="hasAnchor">
<a href="#the-class-module" class="anchor"></a>The <code>class</code> module</h3>
<p>To make hard class predictions, the <code>class</code> object contains the details. The elements of the list are:</p>
<ul>
<li>
<code>pre</code> and <code>post</code> are optional functions that can preprocess the data being fed to the prediction code and to postprocess the raw output of the predictions. These won’t be need for this example, but a section below has examples of how these can be used when the model code is not easy to use. If the data being predicted has a simple type requirement, you can avoid using a <code>pre</code> function with the <code>args</code> below.</li>
<li>
<code>func</code> is the prediction function (in the same format as above). In many cases, packages have a predict method for their model’s class but this is typically not exported. In this case (and the example below), it is simple enough to make a generic call to <code>predict</code> with no associated package.</li>
<li>
<code>args</code> is a list of arguments to pass to the prediction function. These will mostly likely be wrapped in <code><a href="https://rlang.r-lib.org/reference/quotation.html">rlang::expr</a></code> so that they are not evaluated when defining the method. For <code>mda</code>, the code would be <code><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict(object, newdata, type = "class")</a></code>. What is actually given to the function is the <code>parsnip</code> model fit object, which includes a sub-object called <code>fit</code> and this houses the <code>mda</code> model object. If the data need to be a matrix or data frame, you could also use <code>new_data = quote(as.data.frame(new_data))</code> and so on.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">mixture_da_mda_data<span class="op">$</span>class &lt;-</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">    <span class="dt">pre =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="dt">post =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    <span class="dt">func =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">fun =</span> <span class="st">"predict"</span>),</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    <span class="dt">args =</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7">      <span class="co"># These lists should be of the form:</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">      <span class="co"># {predict.mda argument name} = {values provided from parsnip objects}</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">        <span class="co"># We don't want the first two arguments evaluated right now</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11">        <span class="co"># since they don't exist yet. `type` is a simple object that</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">        <span class="co"># doesn't need to have its evaluation deferred. </span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">        <span class="dt">object =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(object<span class="op">$</span>fit),</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">        <span class="dt">newdata =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(new_data),</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">        <span class="dt">type =</span> <span class="st">"class"</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">      )</a>
<a class="sourceLine" id="cb9-17" data-line-number="17">  )</a></code></pre></div>
<p>The <code>predict_class</code> function will expect the result to be an unnamed character string or factor. This will be coerced to a factor with the same levels as the original data. As with the <code>pred</code> module, the user doesn’t call <code>predict_class</code> but uses <code>predict</code> instead and this produces a tibble with a column named <code>.pred_class</code> <a href="https://tidymodels.github.io/model-implementation-principles/model-predictions.html#return-values">per the model guidlines</a>.</p>
</div>
<div id="the-classprob-module" class="section level3">
<h3 class="hasAnchor">
<a href="#the-classprob-module" class="anchor"></a>The <code>classprob</code> module</h3>
<p>This defines the class probabilities (if they can be computed). The format is identical to the <code>class</code> module but the output is expected to be a tibble with columns for each factor level.</p>
<p>As an example of the <code>post</code> function, the data frame created by <code>mda:::predict.mda</code> will be converted to a tibble. The arguments are <code>x</code> (the raw results coming from the predict method) and <code>object</code> (the <code>parsnip</code> model fit object). The latter has a sub-object called <code>lvl</code> which is a character string of the outcome’s factor levels (if any).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">mixture_da_mda_data<span class="op">$</span>classprob &lt;-</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">    <span class="dt">pre =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="dt">post =</span> <span class="cf">function</span>(x, object) {</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">        tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span>(x)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">      },</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">    <span class="dt">func =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">fun =</span> <span class="st">"predict"</span>),</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">    <span class="dt">args =</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">        <span class="dt">object =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(object<span class="op">$</span>fit),</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        <span class="dt">newdata =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substitute">quote</a></span>(new_data),</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        <span class="dt">type =</span> <span class="st">"posterior"</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13">      )</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">  )</a></code></pre></div>
<p>The <code>post</code> element converts the output to a tibble but the main <code>predict</code> method does proper naming of the column names.</p>
</div>
</div>
<div id="does-it-work" class="section level2">
<h2 class="hasAnchor">
<a href="#does-it-work" class="anchor"></a>Does it Work?</h2>
<p>As a developer, one thing that may come in handy is the <code>translate</code> function. This will tell you what the model’s eventual syntax will be.</p>
<p>For example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidymodels)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">mixture_da</span>(<span class="dt">sub_classes =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../../reference/set_engine.html">set_engine</a></span>(<span class="st">"mda"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="../../reference/translate.html">translate</a></span>()</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; Model Specification (classification)</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; Main Arguments:</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt;   sub_classes = 2</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="co">#&gt; Computational engine: mda </span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; Model fit template:</span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; mda::mda(formula = missing_arg(), data = missing_arg(), weights = missing_arg(), </span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt;     sub_classes = 2)</span></a></code></pre></div>
<p>Let’s try it on the iris data:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">4622</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">iris_split &lt;-<span class="st"> </span><span class="kw">initial_split</span>(iris, <span class="dt">prop =</span> <span class="fl">0.90</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">iris_train &lt;-<span class="st"> </span><span class="kw">training</span>(iris_split)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">iris_test  &lt;-<span class="st">  </span><span class="kw">testing</span>(iris_split)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">mda_spec &lt;-<span class="st"> </span><span class="kw">mixture_da</span>(<span class="dt">sub_classes =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-7" data-line-number="7"></a>
<a class="sourceLine" id="cb12-8" data-line-number="8">mda_fit &lt;-<span class="st"> </span>mda_spec <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="../../reference/set_engine.html">set_engine</a></span>(<span class="st">"mda"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/generics/topics/fit">fit</a></span>(Species <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris_train)</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">mda_fit</a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt; parsnip model object</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt; mda::mda(formula = formula, data = data, sub_classes = ~2)</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt; Dimension: 4 </span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt; Percent Between-Group Variance Explained:</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#&gt;    v1    v2    v3    v4 </span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#&gt;  95.8  98.3  99.9 100.0 </span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co">#&gt; Degrees of Freedom (per dimension): 5 </span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co">#&gt; Training Misclassification Error: 0.0221 ( N = 136 )</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co">#&gt; Deviance: 13.4</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(mda_fit, <span class="dt">new_data =</span> iris_test) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="st">  </span><span class="kw">bind_cols</span>(iris_test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Species))</a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#&gt; # A tibble: 14 x 2</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#&gt;    .pred_class Species   </span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#&gt;    &lt;fct&gt;       &lt;fct&gt;     </span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#&gt;  1 setosa      setosa    </span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co">#&gt;  2 setosa      setosa    </span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co">#&gt;  3 setosa      setosa    </span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="co">#&gt;  4 setosa      setosa    </span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co">#&gt;  5 versicolor  versicolor</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="co">#&gt;  6 versicolor  versicolor</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"><span class="co">#&gt;  7 versicolor  versicolor</span></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co">#&gt;  8 versicolor  versicolor</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"><span class="co">#&gt;  9 versicolor  versicolor</span></a>
<a class="sourceLine" id="cb12-43" data-line-number="43"><span class="co">#&gt; 10 virginica   virginica </span></a>
<a class="sourceLine" id="cb12-44" data-line-number="44"><span class="co">#&gt; 11 virginica   virginica </span></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="co">#&gt; 12 virginica   virginica </span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46"><span class="co">#&gt; 13 virginica   virginica </span></a>
<a class="sourceLine" id="cb12-47" data-line-number="47"><span class="co">#&gt; 14 virginica   virginica</span></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(mda_fit, <span class="dt">new_data =</span> iris_test, <span class="dt">type =</span> <span class="st">"prob"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-50" data-line-number="50"><span class="st">  </span><span class="kw">bind_cols</span>(iris_test <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Species))</a>
<a class="sourceLine" id="cb12-51" data-line-number="51"><span class="co">#&gt; # A tibble: 14 x 4</span></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="co">#&gt;    .pred_setosa .pred_versicolor .pred_virginica Species   </span></a>
<a class="sourceLine" id="cb12-53" data-line-number="53"><span class="co">#&gt;           &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt; &lt;fct&gt;     </span></a>
<a class="sourceLine" id="cb12-54" data-line-number="54"><span class="co">#&gt;  1    1.00e+  0         5.97e-24        1.64e-65 setosa    </span></a>
<a class="sourceLine" id="cb12-55" data-line-number="55"><span class="co">#&gt;  2    1.00e+  0         8.08e-28        2.99e-65 setosa    </span></a>
<a class="sourceLine" id="cb12-56" data-line-number="56"><span class="co">#&gt;  3    1.00e+  0         1.09e-22        1.16e-60 setosa    </span></a>
<a class="sourceLine" id="cb12-57" data-line-number="57"><span class="co">#&gt;  4    1.00e+  0         6.82e-29        1.09e-72 setosa    </span></a>
<a class="sourceLine" id="cb12-58" data-line-number="58"><span class="co">#&gt;  5    2.21e- 53         9.99e- 1        9.37e- 4 versicolor</span></a>
<a class="sourceLine" id="cb12-59" data-line-number="59"><span class="co">#&gt;  6    3.02e- 30        10.00e- 1        4.74e- 8 versicolor</span></a>
<a class="sourceLine" id="cb12-60" data-line-number="60"><span class="co">#&gt;  7    4.61e- 33        10.00e- 1        1.77e- 6 versicolor</span></a>
<a class="sourceLine" id="cb12-61" data-line-number="61"><span class="co">#&gt;  8    2.78e- 45         9.99e- 1        1.03e- 3 versicolor</span></a>
<a class="sourceLine" id="cb12-62" data-line-number="62"><span class="co">#&gt;  9    1.33e- 21        10.00e- 1        3.46e-14 versicolor</span></a>
<a class="sourceLine" id="cb12-63" data-line-number="63"><span class="co">#&gt; 10    2.87e- 76         3.93e- 4       10.00e- 1 virginica </span></a>
<a class="sourceLine" id="cb12-64" data-line-number="64"><span class="co">#&gt; 11    3.73e- 71         4.69e- 5       10.00e- 1 virginica </span></a>
<a class="sourceLine" id="cb12-65" data-line-number="65"><span class="co">#&gt; 12    2.26e-111         4.48e-15       10.00e- 1 virginica </span></a>
<a class="sourceLine" id="cb12-66" data-line-number="66"><span class="co">#&gt; 13    1.12e- 58         2.24e- 1        7.76e- 1 virginica </span></a>
<a class="sourceLine" id="cb12-67" data-line-number="67"><span class="co">#&gt; 14    2.54e- 56         1.86e- 1        8.14e- 1 virginica</span></a></code></pre></div>
</div>
<div id="pro-tips-what-ifs-exceptions-faq-and-minutiae" class="section level1">
<h1 class="hasAnchor">
<a href="#pro-tips-what-ifs-exceptions-faq-and-minutiae" class="anchor"></a>Pro-tips, what-ifs, exceptions, FAQ, and minutiae</h1>
<p>There are various things that came to mind while writing this document.</p>
<div id="do-i-have-to-return-a-simple-vector-for-predict_num-and-predict_class" class="section level3">
<h3 class="hasAnchor">
<a href="#do-i-have-to-return-a-simple-vector-for-predict_num-and-predict_class" class="anchor"></a>Do I have to return a simple vector for <code>predict_num</code> and <code>predict_class</code>?</h3>
<p>Previously, when discussing the <code>numeric</code> information:</p>
<blockquote>
<p>For <code>numeric</code>, the model requires an unnamed numeric vector output <strong>(usually)</strong>.</p>
</blockquote>
<p>There are some occasions where a prediction for a single new sample may be multidimensional. Examples are enumerated <a href="https://tidymodels.github.io/model-implementation-principles/notes.html#list-cols">here</a> but some easy examples are:</p>
<ul>
<li>confidence or prediction intervals</li>
<li>quantile regression predictions.</li>
</ul>
<p>and so on. These can be accomodated via <code>predict.model_fit</code> using different <code>type</code> arguments.</p>
<p>However, there are some models (e.g. <code>glmnet</code>, <code>plsr</code>, <code>Cubist</code>, etc.) that can make predictions for different models from the same fitted model object. The regular <code>predict</code> method requires prediction from a single model but the <code>multi_predict</code> can. The guideline is to <em>always return the same number of rows as in <code>new_data</code></em>. This means that the <code>.pred</code> column is a list-column of tibbles.</p>
<p>For example, for a multinomial <code>glmnet</code> model, we leave <code>penalty</code> unspecified when fitting and get predictions on a sequence of values:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">mod &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/multinom_reg.html">multinom_reg</a></span>(<span class="dt">mixture =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../../reference/set_engine.html">set_engine</a></span>(<span class="st">"glmnet"</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">mod_fit &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/generics/topics/fit">fit</a></span>(mod, Species <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> iris)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">preds &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/multi_predict.html">multi_predict</a></span>(mod_fit, iris[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dv">-5</span>], <span class="dt">penalty =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>), <span class="dt">type =</span> <span class="st">"prob"</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">preds</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt; # A tibble: 3 x 1</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt;   .pred           </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt;   &lt;list&gt;          </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt; 1 &lt;tibble [3 × 4]&gt;</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt; 2 &lt;tibble [3 × 4]&gt;</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; 3 &lt;tibble [3 × 4]&gt;</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">preds[[<span class="st">".pred"</span>]][<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; # A tibble: 3 x 4</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt;   .pred_setosa .pred_versicolor .pred_virginica penalty</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt;          &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; 1        1.000         0.000231        5.70e-22    0   </span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#&gt; 2        0.980         0.0197          3.13e- 7    0.01</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co">#&gt; 3        0.876         0.113           1.12e- 2    0.1</span></a></code></pre></div>
<p>This can be easily expanded to remove the list columns:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">preds <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">.row =</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(preds)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>()</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#&gt; # A tibble: 9 x 5</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co">#&gt;    .row .pred_setosa .pred_versicolor .pred_virginica penalty</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt;   &lt;int&gt;        &lt;dbl&gt;            &lt;dbl&gt;           &lt;dbl&gt;   &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; 1     1        1.000         0.000231        5.70e-22    0   </span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt; 2     1        0.980         0.0197          3.13e- 7    0.01</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co">#&gt; 3     1        0.876         0.113           1.12e- 2    0.1 </span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co">#&gt; 4     2        0.998         0.00201         6.26e-20    0   </span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co">#&gt; 5     2        0.940         0.0601          1.41e- 6    0.01</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co">#&gt; 6     2        0.780         0.207           1.35e- 2    0.1 </span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt; 7     3        1.000         0.000218        2.24e-21    0   </span></a>
<a class="sourceLine" id="cb14-14" data-line-number="14"><span class="co">#&gt; 8     3        0.975         0.0247          4.41e- 7    0.01</span></a>
<a class="sourceLine" id="cb14-15" data-line-number="15"><span class="co">#&gt; 9     3        0.847         0.143           1.00e- 2    0.1</span></a></code></pre></div>
<p><code>multi_predict</code> doesn’t exist for every model and needs to be implmented by the developer. See <code><a href="https://www.rdocumentation.org/packages/utils/topics/methods">methods("multi_predict")</a></code> for examples in this package.</p>
</div>
<div id="what-is-the-defaults-slot-and-why-do-i-need-it" class="section level3">
<h3 class="hasAnchor">
<a href="#what-is-the-defaults-slot-and-why-do-i-need-it" class="anchor"></a>What is the <code>defaults</code> slot and why do I need it?</h3>
<p>You might want to set defaults that can be overridden by the user. For example, for logistic regression with <code>glm</code>, it make sense to default <code>family = binomial</code>. However, if someone wants to use a different link function, they should be able to do that. For that model/engine definition, it has</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">defaults =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">family =</span> <span class="kw">expr</span>(stats<span class="op">::</span>binomial))</a></code></pre></div>
<p>so that is the default:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw"><a href="../../reference/logistic_reg.html">logistic_reg</a></span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/translate.html">translate</a></span>(<span class="dt">engine =</span> <span class="st">"glm"</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="co">#&gt; Logistic Regression Model Specification (classification)</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co">#&gt; Computational engine: glm </span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt; Model fit template:</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; stats::glm(formula = missing_arg(), data = missing_arg(), weights = missing_arg(), </span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt;     family = stats::binomial)</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co"># but you can change it:</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"></a>
<a class="sourceLine" id="cb16-12" data-line-number="12"><span class="kw"><a href="../../reference/logistic_reg.html">logistic_reg</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="st">  </span><span class="kw"><a href="../../reference/set_engine.html">set_engine</a></span>(<span class="st">"glm"</span>, <span class="dt">family =</span> stats<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">binomial</a></span>(<span class="dt">link =</span> <span class="st">"probit"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="st">  </span><span class="kw"><a href="../../reference/translate.html">translate</a></span>()</a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="co">#&gt; Logistic Regression Model Specification (classification)</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="co">#&gt; Engine-Specific Arguments:</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18"><span class="co">#&gt;   family = stats::binomial(link = "probit")</span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20"><span class="co">#&gt; Computational engine: glm </span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb16-22" data-line-number="22"><span class="co">#&gt; Model fit template:</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"><span class="co">#&gt; stats::glm(formula = missing_arg(), data = missing_arg(), weights = missing_arg(), </span></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="co">#&gt;     family = stats::binomial(link = "probit"))</span></a></code></pre></div>
<p>That’s what <code>defaults</code> are for.</p>
<p>Note that I wrapped <code>binomial</code> inside of <code>expr</code>. If I didn’t, it would substitute the results of executing <code>binomial</code> inside of the expression (and that’s a mess). Using namespaces is a good idea here.</p>
</div>
<div id="what-if-i-want-more-complex-defaults" class="section level3">
<h3 class="hasAnchor">
<a href="#what-if-i-want-more-complex-defaults" class="anchor"></a>What if I want more complex defaults?</h3>
<p>The <code>translate</code> function can be used to check values or set defaults once the model’s mode is known. To do this, you can create a model-specific S3 method that first calls the general method (<code>translate.model_spec</code>) and then makes modifications or conducts error traps.</p>
<p>For example, the <code>ranger</code> and <code>randomForest</code> package functions have arguments for calculating importance. One is a logical and the other is a string. Since this is likely to lead to a bunch of frustration and GH issues, we can put in a check:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="co"># Simplified version</span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2">translate.rand_forest &lt;-<span class="st"> </span><span class="cf">function</span> (x, <span class="dt">engine =</span> x<span class="op">$</span>engine, ...){</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="co"># Run the general method to get the real arguments in place</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  x &lt;-<span class="st"> </span><span class="kw">translate.default</span>(x, engine, ...)</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  <span class="co"># Make code easier to read</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  arg_vals &lt;-<span class="st"> </span>x<span class="op">$</span>method<span class="op">$</span>fit<span class="op">$</span>args</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb17-9" data-line-number="9">  <span class="co"># Check and see if they make sense for the engine and/or mode:</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10">  <span class="cf">if</span> (engine <span class="op">==</span><span class="st"> "ranger"</span>) {</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">    <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/any">any</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(arg_vals) <span class="op">==</span><span class="st"> "importance"</span>)) </a>
<a class="sourceLine" id="cb17-12" data-line-number="12">      <span class="co"># We want to check the type of `importance` but it is a quosure. We first</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13">      <span class="co"># get the expression. It is is logical, the value of `quo_get_expr` will</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14">      <span class="co"># not be an expression but the actual logical. The wrapping of `isTRUE`</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15">      <span class="co"># is there in case it is not an atomic value. </span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16">      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Logic">isTRUE</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">is.logical</a></span>(<span class="kw">quo_get_expr</span>(arg_vals<span class="op">$</span>importance)))) </a>
<a class="sourceLine" id="cb17-17" data-line-number="17">        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop</a></span>(<span class="st">"`importance` should be a character value. See ?ranger::ranger."</span>, </a>
<a class="sourceLine" id="cb17-18" data-line-number="18">             <span class="dt">call. =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb17-19" data-line-number="19">    <span class="cf">if</span> (x<span class="op">$</span>mode <span class="op">==</span><span class="st"> "classification"</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/any">any</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(arg_vals) <span class="op">==</span><span class="st">  "probability"</span>)) </a>
<a class="sourceLine" id="cb17-20" data-line-number="20">      arg_vals<span class="op">$</span>probability &lt;-<span class="st"> </span><span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb17-21" data-line-number="21">  }</a>
<a class="sourceLine" id="cb17-22" data-line-number="22">  x<span class="op">$</span>method<span class="op">$</span>fit<span class="op">$</span>args &lt;-<span class="st"> </span>arg_vals</a>
<a class="sourceLine" id="cb17-23" data-line-number="23">  x</a>
<a class="sourceLine" id="cb17-24" data-line-number="24">}</a></code></pre></div>
<p>As another example, <code><a href="https://www.rdocumentation.org/packages/nnet/topics/nnet">nnet::nnet</a></code> has an option for the final layer to be linear (called <code>linout</code>). If <code>mode = "regression"</code>, that should probably be set to <code>TRUE</code>. You couldn’t do this with the <code>args</code> (described above) since you need the function translated first.</p>
<p>In cases where the model requires different defaults, the <code>translate</code> method can also be used. See the code for the <code>mars</code> function to see how to check and potentially switch arguments for classification models.</p>
</div>
<div id="my-model-fit-requires-more-than-one-function-call--so-" class="section level3">
<h3 class="hasAnchor">
<a href="#my-model-fit-requires-more-than-one-function-call--so-" class="anchor"></a>My model fit requires more than one function call. So….?</h3>
<p>The best course of action is to write wrapper so that it can be one call. This was the case with <code>xgboost</code>, <code>C5.0</code>, and <code>keras</code>.</p>
</div>
<div id="why-would-i-preprocess-my-data" class="section level3">
<h3 class="hasAnchor">
<a href="#why-would-i-preprocess-my-data" class="anchor"></a>Why would I preprocess my data?</h3>
<p>There might be non-trivial transformations that the model prediction code requires (such as converting to a sparse matrix representation, etc.)</p>
<p>This would <strong>not</strong> include making dummy variables and <code>model.matrix</code> stuff. <code>parsnip</code> already does that for you.</p>
</div>
<div id="why-would-i-postprocess-my-predictions" class="section level3">
<h3 class="hasAnchor">
<a href="#why-would-i-postprocess-my-predictions" class="anchor"></a>Why would I postprocess my predictions?</h3>
<p>What comes back from some R functions make be somewhat… arcane or problematic. As an example, for <code>xgboost</code>, if you fit a multiclass boosted tree, you might expect the class probabilities to come back as a matrix<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. If you have four classes and make predictions on three samples, you get a vector of 12 probability values. You need to convert these to a rectangular data set.</p>
<p>Another example is the predict method for <code>ranger</code>, which encapsulates the actual predictions in a more complex object structure.</p>
<p>These are the types of problems that the postprocessor will solve.</p>
</div>
<div id="are-there-other-modes" class="section level3">
<h3 class="hasAnchor">
<a href="#are-there-other-modes" class="anchor"></a>Are there other modes?</h3>
<p>Not yet but there will be. For example, it might make sense to have a different mode when doing risk-based modeling via Cox regression models. That would enable different classes of objects and those might be needed since the types of models don’t make direct predictions of the outcome.</p>
<p>If you have a suggestion, please ad a GitHub issue to discuss it.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><em>narrator</em>: they don’t<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#step-1--make-the-objects-for-the-general-method">Step 1. Make the objects for the general method</a></li>
      <li><a href="#step-2--create-the-model-function">Step 2. Create the model function</a></li>
      <li><a href="#step-3--make-the-model-object">Step 3. Make the model object</a></li>
      <li><a href="#does-it-work">Does it Work?</a></li>
      <li><a href="#pro-tips-what-ifs-exceptions-faq-and-minutiae">Pro-tips, what-ifs, exceptions, FAQ, and minutiae</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="tidyverse">
  <p><code>parsnip</code> is a part of the <strong>tidymodels</strong> ecosystem, a collection of modeling packages designed with common APIs and a shared philosophy.</p>
</div>

<div class="author">
  <p>
    Developed by Max Kuhn, Davis Vaughan.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>
      </footer>
</div>

  

  </body>
</html>
